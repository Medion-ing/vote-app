---
- name: D√©ployer Prometheus, Grafana et dashboard FINAL
  hosts: k8s_master
  become: yes
  vars:
    namespace: "vote-app"
    grafana_admin_user: "admin"
    grafana_admin_password: "admin"
    grafana_url: "http://localhost:31000"

  tasks:

    # === Nettoyage et installation ===
    - name: Supprimer l'existant
      shell: |
        microk8s helm3 uninstall prometheus -n {{ namespace }} 2>/dev/null || true
        microk8s helm3 uninstall grafana -n {{ namespace }} 2>/dev/null || true
      environment:
        PATH: "/snap/bin:{{ ansible_env.PATH }}"

    - name: Installer Prometheus
      shell: |
        microk8s helm3 upgrade --install prometheus prometheus-community/prometheus \
          --namespace {{ namespace }} \
          --set server.persistentVolume.enabled=false \
          --set alertmanager.persistentVolume.enabled=false \
          --set server.service.type=NodePort \
          --set server.service.nodePort=30900 \
          --set nodeExporter.enabled=true \
          --set kubeStateMetrics.enabled=true
      environment:
        PATH: "/snap/bin:{{ ansible_env.PATH }}"

    - name: Installer Grafana
      shell: |
        microk8s helm3 upgrade --install grafana grafana/grafana \
          --namespace {{ namespace }} \
          --set adminUser={{ grafana_admin_user }} \
          --set adminPassword={{ grafana_admin_password }} \
          --set service.type=NodePort \
          --set service.nodePort=31000 \
          --set persistence.enabled=false
      environment:
        PATH: "/snap/bin:{{ ansible_env.PATH }}"

    # === Attendre que tout soit pr√™t ===
    - name: Attendre Grafana
      shell: |
        timeout 180 bash -c '
          while ! curl -s "{{ grafana_url }}/api/health" | grep -q "ok"; do
            sleep 10;
          done
          echo "Grafana ready!"
        '
      register: wait_grafana

    # === Configurer Grafana ===
    - name: Configurer datasource Prometheus
      uri:
        url: "{{ grafana_url }}/api/datasources"
        method: POST
        body_format: json
        body:
          name: "Prometheus"
          type: "prometheus"
          url: "http://prometheus-server.vote-app.svc.cluster.local:80"
          access: "proxy"
          isDefault: true
        user: "{{ grafana_admin_user }}"
        password: "{{ grafana_admin_password }}"
        status_code: 200
        force_basic_auth: yes
      register: datasource_setup

    - name: Cr√©er dashboard FINAL
      uri:
        url: "{{ grafana_url }}/api/dashboards/db"
        method: POST
        body_format: json
        body: |
          {
            "dashboard": {
              "id": null,
              "title": "Kubernetes Monitoring",
              "tags": ["kubernetes", "microk8s"],
              "timezone": "browser",
              "panels": [
                {
                  "id": 1,
                  "title": "Cluster Nodes",
                  "type": "stat",
                  "gridPos": {"h": 8, "w": 6, "x": 0, "y": 0},
                  "targets": [
                    {
                      "expr": "count(kube_node_info)",
                      "refId": "A"
                    }
                  ],
                  "fieldConfig": {
                    "defaults": {
                      "color": {"mode": "palette-classic"},
                      "unit": "short"
                    }
                  }
                },
                {
                  "id": 2,
                  "title": "Total Pods",
                  "type": "stat",
                  "gridPos": {"h": 8, "w": 6, "x": 6, "y": 0},
                  "targets": [
                    {
                      "expr": "count(kube_pod_info)",
                      "refId": "A"
                    }
                  ],
                  "fieldConfig": {
                    "defaults": {
                      "color": {"mode": "palette-classic"},
                      "unit": "short"
                    }
                  }
                },
                {
                  "id": 3,
                  "title": "Running Pods",
                  "type": "stat",
                  "gridPos": {"h": 8, "w": 6, "x": 12, "y": 0},
                  "targets": [
                    {
                      "expr": "sum(kube_pod_status_phase{phase=\"Running\"})",
                      "refId": "A"
                    }
                  ],
                  "fieldConfig": {
                    "defaults": {
                      "color": {"mode": "palette-classic"},
                      "unit": "short"
                    }
                  }
                },
                {
                  "id": 4,
                  "title": "Pods in vote-app",
                  "type": "stat",
                  "gridPos": {"h": 8, "w": 6, "x": 18, "y": 0},
                  "targets": [
                    {
                      "expr": "count(kube_pod_info{namespace=\"vote-app\"})",
                      "refId": "A"
                    }
                  ],
                  "fieldConfig": {
                    "defaults": {
                      "color": {"mode": "palette-classic"},
                      "unit": "short"
                    }
                  }
                },
                {
                  "id": 5,
                  "title": "CPU Usage - All Nodes",
                  "type": "timeseries",
                  "gridPos": {"h": 8, "w": 12, "x": 0, "y": 8},
                  "targets": [
                    {
                      "expr": "sum(rate(container_cpu_usage_seconds_total{container!=\"POD\"}[5m])) by (node)",
                      "refId": "A"
                    }
                  ],
                  "fieldConfig": {
                    "defaults": {
                      "color": {"mode": "palette-classic"},
                      "unit": "percentunit"
                    }
                  }
                },
                {
                  "id": 6,
                  "title": "Memory Usage - All Nodes (MB)",
                  "type": "timeseries",
                  "gridPos": {"h": 8, "w": 12, "x": 12, "y": 8},
                  "targets": [
                    {
                      "expr": "sum(container_memory_working_set_bytes{container!=\"POD\"}) by (node) / 1024 / 1024",
                      "refId": "A"
                    }
                  ],
                  "fieldConfig": {
                    "defaults": {
                      "color": {"mode": "palette-classic"},
                      "unit": "megabytes"
                    }
                  }
                },
                {
                  "id": 7,
                  "title": "CPU Usage - Vote App Pods",
                  "type": "timeseries",
                  "gridPos": {"h": 8, "w": 12, "x": 0, "y": 16},
                  "targets": [
                    {
                      "expr": "sum(rate(container_cpu_usage_seconds_total{namespace=\"vote-app\", container!=\"POD\"}[5m])) by (pod)",
                      "refId": "A"
                    }
                  ],
                  "fieldConfig": {
                    "defaults": {
                      "color": {"mode": "palette-classic"},
                      "unit": "percentunit"
                    }
                  }
                },
                {
                  "id": 8,
                  "title": "Memory Usage - Vote App Pods (MB)",
                  "type": "timeseries",
                  "gridPos": {"h": 8, "w": 12, "x": 12, "y": 16},
                  "targets": [
                    {
                      "expr": "sum(container_memory_working_set_bytes{namespace=\"vote-app\", container!=\"POD\"}) by (pod) / 1024 / 1024",
                      "refId": "A"
                    }
                  ],
                  "fieldConfig": {
                    "defaults": {
                      "color": {"mode": "palette-classic"},
                      "unit": "megabytes"
                    }
                  }
                },
                {
                  "id": 9,
                  "title": "Pod Restarts - Vote App",
                  "type": "timeseries",
                  "gridPos": {"h": 8, "w": 12, "x": 0, "y": 24},
                  "targets": [
                    {
                      "expr": "sum(kube_pod_container_status_restarts_total{namespace=\"vote-app\"}) by (pod)",
                      "refId": "A"
                    }
                  ],
                  "fieldConfig": {
                    "defaults": {
                      "color": {"mode": "palette-classic"},
                      "unit": "short"
                    }
                  }
                },
                {
                  "id": 10,
                  "title": "All Pods in Cluster",
                  "type": "table",
                  "gridPos": {"h": 12, "w": 24, "x": 0, "y": 32},
                  "targets": [
                    {
                      "expr": "kube_pod_info",
                      "format": "table",
                      "instant": true,
                      "refId": "A"
                    }
                  ],
                  "fieldConfig": {
                    "defaults": {
                      "color": {"mode": "palette-classic"}
                    }
                  }
                }
              ],
              "time": {
                "from": "now-1h",
                "to": "now"
              },
              "refresh": "10s"
            },
            "overwrite": true
          }
        user: "{{ grafana_admin_user }}"
        password: "{{ grafana_admin_password }}"
        status_code: 200
        force_basic_auth: yes
      register: dashboard_result

    # === V√©rification finale ===
    - name: V√©rifier l'√©tat des pods
      shell: microk8s kubectl get pods -n {{ namespace }}
      environment:
        PATH: "/snap/bin:{{ ansible_env.PATH }}"
      register: final_pods

    - name: V√©rifier l'√©tat des services
      shell: microk8s kubectl get svc -n {{ namespace }}
      environment:
        PATH: "/snap/bin:{{ ansible_env.PATH }}"
      register: final_services

    - name: Afficher le r√©sultat final
      debug:
        msg: |
          üéâ D√âPLOIEMENT R√âUSSI !

          üìä Grafana : {{ grafana_url }}
          üîç Prometheus : http://{{ ansible_host }}:30900
          üë§ Compte : {{ grafana_admin_user }}/{{ grafana_admin_password }}

          ‚úÖ Dashboard "Kubernetes Monitoring" cr√©√© avec succ√®s !
          ‚úÖ Datasource Prometheus configur√© !
          ‚úÖ Tout est op√©rationnel !

          üìà Les m√©triques s'afficheront dans 1-2 minutes.

          √âtat actuel :
          {{ final_pods.stdout }}